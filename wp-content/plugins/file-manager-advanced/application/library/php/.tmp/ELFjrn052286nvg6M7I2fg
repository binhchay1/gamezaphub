<?php
/**
 * Avatar Helper Class - Tối ưu hóa avatar theo kích thước thực tế
 * 
 * Giải quyết vấn đề:
 * - Avatar hiển thị 25px nhưng tải ảnh 150x150
 * - Avatar hiển thị 80px nhưng tải ảnh 300x300 (do srcset)
 * - Cải thiện PageSpeed và giảm băng thông
 */

class Blogarise_Avatar_Helper {
    
    private static $instance = null;
    
    /**
     * Singleton pattern
     */
    public static function get_instance() {
        if (null === self::$instance) {
            self::$instance = new self();
        }
        return self::$instance;
    }
    
    /**
     * Constructor - Khởi tạo hooks
     */
    private function __construct() {
        add_action('init', array($this, 'init_hooks'));
    }
    
    /**
     * Khởi tạo các hooks
     */
    public function init_hooks() {
        // Hook để tối ưu hóa srcset - chỉ tạo srcset khi thực sự cần thiết
        add_filter('get_avatar', array($this, 'optimize_avatar_srcset'), 10, 6);
        
        // Hook để tối ưu hóa avatar URL
        add_filter('get_avatar_url', array($this, 'optimize_avatar_url'), 10, 3);
    }
    
    /**
     * Tối ưu hóa srcset - loại bỏ srcset cho avatar nhỏ
     */
    public function optimize_avatar_srcset($avatar, $id_or_email, $size, $default, $alt, $args) {
        // Chỉ áp dụng cho avatar có kích thước nhỏ hơn 96px
        if ($size < 96) {
            // Loại bỏ srcset cho avatar nhỏ để tránh tải ảnh lớn không cần thiết
            $avatar = preg_replace('/ssrcset="[^"]*"/', '', $avatar);
        }
        
        return $avatar;
    }
    
    /**
     * Tối ưu hóa avatar URL - tránh tải ảnh quá lớn
     */
    public function optimize_avatar_url($url, $id_or_email, $args) {
        // Nếu size quá lớn so với nhu cầu, giảm xuống
        if (isset($args['size']) && $args['size'] > 96) {
            $args['size'] = 96;
            // Tạo lại URL với kích thước tối ưu
            $url = get_avatar_url($id_or_email, $args);
        }
        
        return $url;
    }
    
    /**
     * Hàm chính để lấy avatar tối ưu
     * 
     * @param int $user_id User ID
     * @param string $context Context của avatar ('small', 'large', 'comment', 'widget')
     * @param string $alt Alt text cho avatar
     * @return string HTML của avatar
     */
    public function get_avatar($user_id, $context = 'small', $alt = '') {
        // Định nghĩa kích thước theo context
        $sizes = array(
            'small' => 36,    // Cho .bs-author .auth img (25px -> 36px để đảm bảo chất lượng)
            'large' => 96,    // Cho .bs-author-pic img (80px -> 96px)
            'comment' => 32,  // Cho comment avatar
            'widget' => 48    // Cho widget avatar
        );
        
        $size = isset($sizes[$context]) ? $sizes[$context] : $sizes['small'];
        
        // Sử dụng get_avatar với kích thước tối ưu
        return get_avatar($user_id, $size, '', $alt, array(
            'loading' => 'lazy', // Lazy loading để tối ưu hiệu suất
            'fetchpriority' => $context === 'large' ? 'high' : 'low'
        ));
    }
    
    /**
     * Hàm helper để lấy avatar nhỏ (25px)
     */
    public function get_small_avatar($user_id, $alt = '') {
        return $this->get_avatar($user_id, 'small', $alt);
    }
    
    /**
     * Hàm helper để lấy avatar lớn (80px)
     */
    public function get_large_avatar($user_id, $alt = '') {
        return $this->get_avatar($user_id, 'large', $alt);
    }
    
    /**
     * Hàm helper để lấy avatar cho comment
     */
    public function get_comment_avatar($user_id, $alt = '') {
        return $this->get_avatar($user_id, 'comment', $alt);
    }
    
    /**
     * Hàm helper để lấy avatar cho widget
     */
    public function get_widget_avatar($user_id, $alt = '') {
        return $this->get_avatar($user_id, 'widget', $alt);
    }
}

// Khởi tạo helper
Blogarise_Avatar_Helper::get_instance();

/**
 * Hàm helper global để sử dụng dễ dàng
 */
function blogarise_optimized_avatar($user_id, $context = 'small', $alt = '') {
    $helper = Blogarise_Avatar_Helper::get_instance();
    return $helper->get_avatar($user_id, $context, $alt);
}

/**
 * Hàm helper global cho avatar nhỏ
 */
function blogarise_small_avatar($user_id, $alt = '') {
    $helper = Blogarise_Avatar_Helper::get_instance();
    return $helper->get_small_avatar($user_id, $alt);
}

/**
 * Hàm helper global cho avatar lớn
 */
function blogarise_large_avatar($user_id, $alt = '') {
    $helper = Blogarise_Avatar_Helper::get_instance();
    return $helper->get_large_avatar($user_id, $alt);
}